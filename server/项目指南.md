# 前端部分

服务端响应的状态码为`200`表示一切成功

客户端面对的是用户，UI尽量做得好看些

## 1.登录注册功能

- 登录：
	- 用户输入正确的邮箱和密码，用户点击登录则向服务端发送请求。服务端响应。状态码为`412`则表示邮箱或者密码有误，向用户展示服务端返回的错误信息
	- 对用户的输入进行校验。确保邮箱的格式正确，密码的长度为`8-20`位
	- 响应成功会收到服务端发送过来的`token`，代表用户的登录信息，储存`token`
- 注册：
	- 用户输入正确的邮箱，点击发送验证码，向服务端发送请求，服务端进行响应，状态码为`418`表示邮箱不存在或已被注册，客户端提示用户
	- 发送验证码有60秒的间隔
	- 用户输入昵称和密码，并填写邮箱中收到的验证码，昵称长度为`2-16`位
	- 用户点击注册则向服务端发送请求。状态码为`412`则表示昵称已被使用，或昵称或密码有误
	- 响应成功就跳转到登录界面

## 2.聊天列表部分

- 获取用户加入的所有群
	- 一进入这个页面就发送请求，获取用户加入的所有群
	- 发送请求时记得携带`token`
	- 状态码为`401`表示未登录或者登录状态失效，跳转到登录页面
	- 请求成功后向用户展示所有的群，优先展示有未读消息标记（以下简称标记）的群
	- 所有的群都与服务端建立webSocket连接（具体怎么连以后再说），确保能实时收到消息
- 创建群功能
	- 用户点击创建群，就向服务端发送请求，成功后就通过服务端返回的数据来建立客户端与新群的连接
	- 将新群展示到页面上
- 删除群功能
	- 鼠标悬浮在对应的群（得是用户自己创建的）或者长按（如果也弄移动端的话），右键触发菜单栏，里面有个删除群选项，点击即可发送删除群请求，记得弄个二次确认
	- 响应成功则在页面上不展示该群
- 断开连接，一旦收到服务端发送过来的某个群的断开连接消息，则与该群断开连接，并不允许用户在该群发送消息或上传图片

## 3.聊天界面部分

- 展示信息，按照信息时间先后展示信息，类似于qq
- 发送消息，可以发送文本信息或者上传图片，确保图片上传的格式正确，能够上传成功
- 接收消息，接收服务端传来的数据，判断是否是图片数据，如果是图片的话，将图片展示到页面上
- 下拉加载
	- 可以鼠标点击下拉加载
	- 也可以鼠标滚轮下拉加载
	- 将当前最上面的消息（最早的）的id发送至服务端，收到服务端传来的数据，并展示出来
- 收到消息后，对应的群标记
	- 如果该群用户正在浏览，则不标记
	- 如果用户后来浏览了带标记的群，则取消标记
	- 不标记或者取消标记则向服务端发送信息，表明该群的消息已读

## 4.其他



# 后端部分

## 0.模块

| 模块名     | 功能                     |      |
| ---------- | ------------------------ | ---- |
| express    | 服务端框架               |      |
| config     | 配置文件，配置信息       |      |
| node-uuid  | 生成唯一id               |      |
| nodemon    | 热重载                   | -D   |
| bcrypt     | 密码加密                 |      |
| joi        | 格式验证                 |      |
| mysql      | 连接数据库               |      |
| formidable | 处理图片文件             |      |
| cross-env  | 跨平台设置和使用环境变量 | -D   |
| morgan     | 日志功能                 |      |

## 1.CORS

- 响应头
	- `Access-Control-Allow-Origin`
	- `Access-Control-Expose-Headers`

## 2.建表

- 创建用户表

  **users**

  | 列名        | 类型        | 说明                 | 其他                 |
  | ----------- | ----------- | -------------------- | -------------------- |
  | uid         | varchar(50) | 用户id               |                      |
  | username    | varchar(20) |                      |                      |
  | password    | varchar(30) |                      | 储存的是加密后的密码 |
  | email       | varchar(20) |                      |                      |
  | last_online | bigint(13) | 上次在线时间，时间戳 |                      |

- 群表，储存所有的群

	**groups**

    | 列名    | 类型           | 说明     | 其他                    |
    | ------- | -------------- | -------- | ----------------------- 
    | gid     | varchar(50)    | 群的id   |                         |
    | name    | varchar(20)    | 群的名字 |                         |
    | members | varchart(5000) | 群成员   | `uid,uid,uid`的格式存储 |
  
- 用户群表，储存用户加入的群

  （joined）**uid**

  | 列名  | 类型        | 说明         | 其他 |
  | ----- | ----------- | ------------ | ---- |
  | group | varchar(50) | 加入的群     |      |
  | read  | tinyint     | 消息是否已读 |      |

- 群消息表，储存一个群的所有消息

  （news）**gid**

  | 列名        | 类型          | 说明                 | 其他 |
  | ----------- | ------------- | -------------------- | ---- |
  | text        | varchar(1000) | 消息内容或图片路径   |      |
  | create_time | bigint(13)   | 消息发表时间，时间戳 |      |

## 3.用户功能

- 注册
  - 根据客户端发送来的邮箱，判断是否存在或已使用，不可行则返回错误
  - 可行就生成`6`位随机数的验码，并设置过期时间，记录该邮箱，向邮箱发送邮件
  - 接收到客户端传来的昵称、密码、验证码
  - 判断昵称是否已存在，判断密码格式是否正确，判断验证码是否正确
- 登录

	- 登陆参数：邮箱、密码，验证参数
	- 生成`token`，设置过期时间
	- 成功则返回成功，并携带`token`

## 4.登录拦截

- 访问登录/注册之外的网址，登录拦截
	- 验证`token`
	- 失败返回 登录失败 或 登录状态失效，状态码`401`

## 5.聊天列表

- 根据客户端携带的`token`识别用户信息，找到对应的`joined`的表
- 将结果排序，有未读消息的群排在前面
- 响应客户端
- 与客户端建立webSocket连接
- 找到对应的群，按时间将消息推送到客户端
  - 将所有`last_online < create_time`的消息及其前20条消息推送到客户端
  - 如果数据是图片路径，则找到对应的图片并发送到客户端


## 6.聊天内容，单个群



## 7.实时响应消息的问题

- 发布订阅机制

